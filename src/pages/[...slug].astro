---
import type { Markdown } from '@/db/types'
import ArticlePage from '@/components/article-view/page.astro'
import { MarkdownSource } from '@/db'
import { read } from '@/db/markdown'
import { retriveRss } from '@/lib/utils/rss'

const { slug } = Astro.params

if (slug === 'rss.xml') {
  return retriveRss(Astro)
}

const maybePage: Markdown | undefined = await read(Astro.locals.runtime?.env, MarkdownSource.Page, slug || '')

if (!maybePage) {
  return Astro.redirect(`/404?source=${encodeURIComponent(Astro.url.pathname)}`)
}
if (maybePage.private) {
  if (!Astro.locals.session.role) {
    return Astro.redirect(`/guest-login?id=${maybePage.id}`)
  }
}
---

<ArticlePage article={maybePage} />
