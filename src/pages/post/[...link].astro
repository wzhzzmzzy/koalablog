---
import type { DoubleLinkPluginOptions } from '@/lib/markdown/double-link-plugin'
import ArticleClient from '@/components/article-view/client.astro'
import ArticleView from '@/components/article-view/index.astro'
import { MarkdownSource } from '@/db'
import Layout from '@/layouts/home.astro'
import { renderIt } from '@/lib/markdown/render-it'
import { readArticle } from '@/lib/services/article'
import { parseJson } from '@/lib/utils/parse-json'

const { link } = Astro.params

if (!link) {
  return Astro.redirect(`/404?source=${encodeURIComponent(Astro.url.pathname)}`)
}

const source = MarkdownSource.Post
const article = await readArticle(Astro, source, link)

if (article instanceof Response) {
  return article
}

const pageConfig = Astro.locals.config.pageConfig
const isBigArticle = (article?.content || '').length > 1000
let outgoingLinks: DoubleLinkPluginOptions['allPostLinks'] | null = null
outgoingLinks = parseJson(article.outgoing_links)

const { content, renderLangSet } = await renderIt(isBigArticle, article, pageConfig.theme, outgoingLinks || [])
const firstParagraph = /<p>(.*?)<\/p>/.exec(content)
---
<Layout title={article.subject} desc={firstParagraph?.[1] || ''}>
  { !isBigArticle
    ? <ArticleView article={article} content={content} />
    : <ArticleClient article={article} content={content} renderLangSet={renderLangSet} />}
</Layout>
