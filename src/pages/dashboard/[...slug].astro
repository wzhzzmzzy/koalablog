---
import { MarkdownSource, MarkdownSourceMap } from '@/db'
import { read } from '@/db/markdown'

const { slug } = Astro.params

type sourceKeys = keyof typeof MarkdownSourceMap

const [sourcePath, ...paths] = (slug ?? '').split('/')

const source: MarkdownSource = MarkdownSourceMap[(sourcePath || 'posts') as sourceKeys] ?? MarkdownSource.Unknown

let maybePage: Markdown | undefined

if (source === MarkdownSource.Unknown) {
  maybePage = await read(Astro.locals.runtime?.env, MarkdownSource.Page, [sourcePath].concat(paths).join('/'))
  if (!maybePage) {
    return Astro.redirect(`/404?source=${encodeURIComponent(Astro.url.pathname)}`)
  }
  else {
    return Astro.redirect(`/dashboard/page/${maybePage.link}`)
  }
}

return Astro.redirect(`/dashboard/edit?source=${source}`)
---
