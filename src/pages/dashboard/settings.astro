---
import ExportZip from '@/components/io/export-zip.svelte'
import ImportFile from '@/components/io/import-file.svelte'
import ThemeSwitch from '@/components/settings/theme-switch.svelte'
import { readToday } from '@/db/ossAccess'
import DashboardLayout from '@/layouts/dashboard.astro'
import { globalConfig } from '@/lib/kv'
import { Save, Upload } from '@lucide/astro'
import { actions } from 'astro:actions'

const saveResult = Astro.getActionResult(actions.form.settings)

const saved = saveResult && !saveResult.error
// Refresh globalConfig after POST
if (saved) {
  const config = await globalConfig(Astro.locals.runtime?.env || {})
  Astro.locals.config = config
}

const pageConfig = Astro.locals.config.pageConfig
const authConfig = Astro.locals.config.auth
const rssConfig = Astro.locals.config.rss
const fontConfig = Astro.locals.config.font

const title = pageConfig.title ?? ''
const avatar = pageConfig.avatar ?? ''
const guestKey = authConfig.guestKey ?? ''
const lightTheme = pageConfig.theme?.light ?? 'latte'
const darkTheme = pageConfig.theme?.dark ?? 'mocha'
const editor = pageConfig.editor ?? 'textarea'

const ossConfig = Astro.locals.config.oss

const ossAccess = await readToday(Astro.locals.runtime?.env)
---
<DashboardLayout>
  <setting-form>
    <form id="settings-form" method="POST" action={actions.form.settings} class="flex flex-col gap-3">
      <header class="flex items-center gap-3">
        <h1 class="my-3">Settings</h1>
        <button class="w-12 py-2 btn">
          <Save />
        </button>
      </header>

      <div>
        { saved && <p class="success mb-0">Saved Successfully</p> }
        { saveResult?.error && <p class="error">{saveResult.error.message}</p> }
      </div>

      <label>
        Blog Title:<br />
      </label>
      <input class="input w-60 sm:w-80" id="title-input" name="title" value={title} />

      <label>
        Avatar:<br />
      </label>
      <div class="flex items-center gap-2">
        <input class="input w-60 sm:w-80" id="avatar-input" name="avatar" value={avatar} />
        <button type="button" id="upload-avatar-btn" class="inline-flex items-center justify-center btn">
           <Upload size={20} />
        </button>
      </div>

      <label>
        Guest Passkey:<br />
      </label>
      <input class="input w-60 sm:w-80" type="password" id="passkey-input" name="guestPasskey" value={guestKey || ''} />

      <label>
      Theme:
      </label>
      <div id="theme-bus" class="hidden">
        <input id="light" type="hidden" name="lightTheme" value={lightTheme} />
        <input id="dark" type="hidden" name="darkTheme" value={darkTheme} />
      </div>
      <ThemeSwitch
        client:load
        light={lightTheme}
        dark={darkTheme}
      />

      <label>
        Default Editor:
      </label>
      <select class="input w-60 sm:w-80" name="editor">
        <option value="textarea" selected={editor === 'textarea'}>Textarea (Legacy)</option>
        <option value="carta" selected={editor === 'carta'}>Carta (Modern)</option>
      </select>

      <label>
        Monthly Read Limit: (today={ossAccess?.readTimes})
      </label>
      <input class="input w-60 sm:w-80" id="read-limit-input" name="readLimit" value={ossConfig.readLimit} />

      <label>
        Monthly Operate Limit: (today={ossAccess?.operateTimes})
      </label>
      <input class="input w-60 sm:w-80" id="operate-limit-input" name="operateLimit" value={ossConfig.operateLimit} />

      <h3>RSS</h3>

      <div>
        <label>Enable</label>
        <input type="checkbox" name="rssEnable" checked={rssConfig?.enable || false} />
      </div>

      <label>Description</label>
      <input class="input w-60 sm:w-80" type="text" name="rssDesc" value={rssConfig?.description} />

      <label>Language</label>
      <input class="input w-60 sm:w-80" type="text" name="rssLang" value={rssConfig?.lang || 'en-US'} />

      <h3>Fonts</h3>
      <label>CDN URL (e.g. Google Fonts CSS link)</label>
      <input class="input w-full" type="text" name="fontCDN" value={fontConfig?.cdn} placeholder="https://fonts.googleapis.com/css2?..." />

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div>
          <label>Sans (UI/Body)</label>
          <input class="input w-full" type="text" name="fontSans" value={fontConfig?.sans} placeholder="'Noto Sans SC', sans-serif" />
        </div>
        <div>
          <label>Serif (Content)</label>
          <input class="input w-full" type="text" name="fontSerif" value={fontConfig?.serif} placeholder="'Noto Serif SC', serif" />
        </div>
        <div>
          <label>Mono (Code)</label>
          <input class="input w-full" type="text" name="fontMono" value={fontConfig?.mono} placeholder="'JetBrains Mono', monospace" />
        </div>
      </div>

    </form>

    <h2>Utility</h2>

    <section class="flex gap-3 flex-col">
      <ImportFile client:load />
      <ExportZip client:load />
    </section>
  </setting-form>
</DashboardLayout>

<script>
import type { CatppuccinTheme } from '@/lib/const/config'
import { pickFileWithFileInput, uploadFile } from '@/lib/services/file-reader'

class SettingForm extends HTMLElement {
  formEl: HTMLFormElement
  titleInputEl: HTMLInputElement
  avatarInputEl: HTMLInputElement
  uploadAvatarBtn: HTMLButtonElement
  themeBusEl: HTMLDivElement
  lightInputEl: HTMLInputElement
  darkInputEl: HTMLInputElement

  theme: {
    light: CatppuccinTheme
    dark: CatppuccinTheme
  }

  constructor() {
    super()
    this.formEl = this.querySelector('#settings-form')!
    this.titleInputEl = this.querySelector('#title-input')!
    this.avatarInputEl = this.querySelector('#avatar-input')!
    this.uploadAvatarBtn = this.querySelector('#upload-avatar-btn')!
    this.themeBusEl = this.querySelector('#theme-bus')!
    this.lightInputEl = this.querySelector('input#light')!
    this.darkInputEl = this.querySelector('input#dark')!

    this.onChangeTheme = this.onChangeTheme.bind(this)
    this.uploadAvatar = this.uploadAvatar.bind(this)

    this.uploadAvatarBtn.addEventListener('click', this.uploadAvatar)

    const light = this.lightInputEl.value as CatppuccinTheme
    const dark = this.darkInputEl.value as CatppuccinTheme
    this.theme = { light, dark }

    this.connectedCallback()
  }

  connectedCallback() {
    this.themeBusEl.addEventListener('update-theme', this.onChangeTheme)
  }

  disconnectedCallback() {
    this.themeBusEl.removeEventListener('update-theme', this.onChangeTheme)
  }

  onChangeTheme(event: CustomEvent<{ light: CatppuccinTheme, dark: CatppuccinTheme }>) {
    this.lightInputEl.value = event.detail.light
    this.darkInputEl.value = event.detail.dark
  }

  async uploadAvatar() {
    try {
      const files = await pickFileWithFileInput()
      if (!files || files.length === 0)
        return

      this.uploadAvatarBtn.disabled = true
      const { data, error } = await uploadFile('oss', files)

      if (error) {
        console.error(error)
        alert(`Upload failed: ${error.message}`)
      }
      else if (data) {
        const url = `/api/oss/${data.replace('/', '_')}`
        this.avatarInputEl.value = url
      }
    }
    catch (e) {
      console.error(e)
      alert('Upload failed')
    }
    finally {
      this.uploadAvatarBtn.disabled = false
    }
  }
}

customElements.define('setting-form', SettingForm)
</script>
