---
import ExportZip from '@/components/io/export-zip.svelte'
import ImportFile from '@/components/io/import-file.svelte'
import ThemeSwitch from '@/components/settings/theme-switch.svelte'
import { readToday } from '@/db/ossAccess'
import DashboardLayout from '@/layouts/dashboard.astro'
import { globalConfig } from '@/lib/kv'
import { actions } from 'astro:actions'

const saveResult = Astro.getActionResult(actions.form.settings)

const saved = saveResult && !saveResult.error
// Refresh globalConfig after POST
if (saved) {
  const config = await globalConfig(Astro.locals.runtime?.env || {})
  Astro.locals.config = config
}

const pageConfig = Astro.locals.config.pageConfig
const authConfig = Astro.locals.config.auth
const rssConfig = Astro.locals.config.rss

const title = pageConfig.title ?? ''
const guestKey = authConfig.guestKey ?? ''
const lightTheme = pageConfig.theme?.light ?? 'latte'
const darkTheme = pageConfig.theme?.dark ?? 'mocha'

const ossConfig = Astro.locals.config.oss

const ossAccess = await readToday(Astro.locals.runtime?.env)
---
<DashboardLayout>
  <h1>Settings</h1>
  <setting-form>

    { saved && <p class="success">Saved Successfully</p> }
    { saveResult?.error && <p class="error">{saveResult.error.message}</p> }

    <form id="settings-form" method="POST" action={actions.form.settings} class="flex flex-col gap-3">
      <button class="w-12">Save</button>

      <label>
        Blog Title:<br />
      </label>
      <input class="w-60 sm:w-80" id="title-input" name="title" value={title} />

      <label>
        Guest Passkey:<br />
      </label>
      <input class="w-60 sm:w-80" type="password" id="passkey-input" name="guestPasskey" value={guestKey || ''} />

      <label>
      Theme:
      </label>
      <div id="theme-bus" class="hidden">
        <input id="light" type="hidden" name="lightTheme" value={lightTheme} />
        <input id="dark" type="hidden" name="darkTheme" value={darkTheme} />
      </div>
      <ThemeSwitch
        client:load
        light={lightTheme}
        dark={darkTheme}
      />

      <label>
        Monthly Read Limit: (today={ossAccess?.readTimes})
      </label>
      <input class="w-60 sm:w-80" id="read-limit-input" name="readLimit" value={ossConfig.readLimit} />

      <label>
        Monthly Operate Limit: (today={ossAccess?.operateTimes})
      </label>
      <input class="w-60 sm:w-80" id="operate-limit-input" name="operateLimit" value={ossConfig.operateLimit} />

      <h3>RSS</h3>

      <div>
        <label>Enable</label>
        <input type="checkbox" name="rssEnable" checked={rssConfig?.enable || false} />
      </div>

      <label>Description</label>
      <input type="text" name="rssDesc" value={rssConfig?.description} />

      <label>Language</label>
      <input type="text" name="rssLang" value={rssConfig?.lang || 'en-US'} />


    </form>

    <h2>Utility</h2>

    <section class="flex gap-3 flex-col">
      <ImportFile client:load />
      <ExportZip client:load />
    </section>
  </setting-form>
</DashboardLayout>

<script>
import type { CatppuccinTheme } from '@/lib/const/config'

class SettingForm extends HTMLElement {
  formEl: HTMLFormElement
  titleInputEl: HTMLInputElement
  themeBusEl: HTMLDivElement
  lightInputEl: HTMLInputElement
  darkInputEl: HTMLInputElement

  theme: {
    light: CatppuccinTheme
    dark: CatppuccinTheme
  }

  constructor() {
    super()
    this.formEl = this.querySelector('#settings-form')!
    this.titleInputEl = this.querySelector('#title-input')!
    this.themeBusEl = this.querySelector('#theme-bus')!
    this.lightInputEl = this.querySelector('input#light')!
    this.darkInputEl = this.querySelector('input#dark')!

    this.onChangeTheme = this.onChangeTheme.bind(this)

    const light = this.lightInputEl.value as CatppuccinTheme
    const dark = this.darkInputEl.value as CatppuccinTheme
    this.theme = { light, dark }

    this.connectedCallback()
  }

  connectedCallback() {
    this.themeBusEl.addEventListener('update-theme', this.onChangeTheme)
  }

  disconnectedCallback() {
    this.themeBusEl.removeEventListener('update-theme', this.onChangeTheme)
  }

  onChangeTheme(event: CustomEvent<{ light: CatppuccinTheme, dark: CatppuccinTheme }>) {
    this.lightInputEl.value = event.detail.light
    this.darkInputEl.value = event.detail.dark
  }
}

customElements.define('setting-form', SettingForm)
</script>
