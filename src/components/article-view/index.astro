---
import type { Markdown } from '@/db/types'
import { MarkdownSource } from '@/db'
import { md } from '@/lib/markdown'
import { formatDate } from 'date-fns'
import './index.css'

interface Props {
  article: Markdown
}

const { article } = Astro.props
const pageConfig = Astro.locals.config.pageConfig

const content = article ? (await md(undefined, pageConfig.theme)).render(article.content ?? '') : ''
const source = article?.source
---

<article-view>
  {
    source === MarkdownSource.Post
  ? (
  <>
    <h1>{ article.subject }</h1>
    <p>{ formatDate(article.createdAt, 'yyyy-MM-dd') }</p>
  </>
  )
  : null
  }
  <article id="article" set:html={content} />
</article-view>

<script>
class ArticleView extends HTMLElement {
  articleEl: HTMLElement | null = null
  mdModulePromise: Promise<typeof import('@/lib/markdown')>

  constructor() {
    super()
    this.mdModulePromise = import('@/lib/markdown')
  }

  async connectedCallback() {
    this.articleEl = this.querySelector('#article')

    const query = window.matchMedia('(prefers-color-scheme: dark)')
    query.addEventListener('change', this.rerenderMd.bind(this))
  }

  async rerenderMd() {
    window.location.reload()
  }
}

customElements.define('article-view', ArticleView)
</script>
