---
import type { MarkdownSource } from '@/db'
import { readList } from '@/db/markdown'
import { format, isSameYear } from 'date-fns'

interface Props {
  source: MarkdownSource
  tag?: string | null
}

const { source, tag } = Astro.props

const env = Astro.locals.runtime?.env || {}
const session = Astro.locals.session

const includePrivate = !!session?.role || false
const list = await readList(env, source, tag || undefined, { includePrivate })
const formatDate = (date: Date) => format(date, isSameYear(date, new Date()) ? 'MM-dd' : 'yyyy-MM-dd')

// Group posts by year
const groupedByYear = list.reduce((groups, item) => {
  if (!item.createdAt)
    return groups

  const year = item.createdAt.getFullYear()
  if (!groups[year]) {
    groups[year] = []
  }
  groups[year].push(item)
  return groups
}, {} as Record<number, typeof list>)

// Sort years in descending order (newest first)
const sortedYears = Object.keys(groupedByYear)
  .map(year => Number.parseInt(year))
  .sort((a, b) => b - a)

const count = list.length
---

{tag && <p class="mb-3">Searching tag: <span class="tag" role="button" tabindex="0" data-tag={tag} title={`Click to search tag: ${tag}`}>{tag}</span> ({count}&nbsp;{count === 1 ? 'article' : 'articles'})</p>}
<markdown-list data-source={source}>
  {
    !list.length ? <div class="mt-3">Nothing here.</div> : null
  }
  {
    sortedYears.map(year => (
      <div>
        <h3 class="text-lg font-light mb-3 mt-0" style="color: var(--koala-editor-text);">
          <i>{year}</i>
          <a class="ml-2" href={`/?s=memo&y=${year}`} title="My Gossips">...</a>
        </h3>
        <ul class="ml-4">
          {
            groupedByYear[year].map(item => (
              <li class="flex gap-3 mb-2">
                { item.createdAt ? <span class="flex-shrink-0"><i>{ formatDate(item.createdAt) }</i></span> : null }
                <a href={`/${item.link}`}><span>{ item.subject } </span></a>
              </li>
            ))
          }
        </ul>
      </div>
    ))
  }
</markdown-list>


<script>
class MarkdownList extends HTMLElement {
  constructor() {
    super()
  }
}

customElements.define('markdown-list', MarkdownList)
</script>
